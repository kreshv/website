<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Listings</title>
    <style>
      :root {
        --bg: #f6efe4;
        --card: #fffaf3;
        --line: #e6d7c2;
        --ink: #2f271f;
        --muted: #716553;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Avenir Next", "Segoe UI", sans-serif;
        background: var(--bg);
        color: var(--ink);
      }

      .wrap {
        width: min(900px, 94vw);
        margin: 26px auto 40px;
      }

      .panel {
        background: var(--card);
        border: 1px solid var(--line);
        border-radius: 16px;
        padding: 16px;
      }

      h1 {
        margin: 0 0 4px;
        font-size: 1.3rem;
      }

      p {
        margin: 0;
        color: var(--muted);
        font-size: 0.92rem;
      }

      form {
        margin-top: 14px;
        display: grid;
        gap: 10px;
      }

      .row {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 10px;
      }

      label {
        display: grid;
        gap: 5px;
        font-size: 0.82rem;
        color: var(--muted);
      }

      input,
      select,
      button {
        font: inherit;
      }

      input,
      select {
        width: 100%;
        border: 1px solid #dbc8ad;
        border-radius: 10px;
        padding: 8px 10px;
        background: #fffdfa;
        color: var(--ink);
      }

      .picker-group {
        display: grid;
        gap: 7px;
      }

      .picker-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 7px;
        border: 1px solid #dbc8ad;
        border-radius: 10px;
        padding: 8px;
        background: #fffdfa;
      }

      .picker-chip {
        border: 1px solid #ddceb8;
        background: #fff7eb;
        color: #4b3d2d;
        border-radius: 999px;
        padding: 5px 10px;
        font-size: 0.8rem;
        line-height: 1.2;
      }

      .picker-chip:hover {
        border-color: #c9b08f;
      }

      .picker-chip.is-selected {
        background: #f1dfc3;
        border-color: #be9b6f;
        color: #2f2417;
      }

      .actions {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 2px;
      }

      button {
        border: 1px solid #d2b995;
        background: #f1dfc3;
        color: #3b2e1f;
        border-radius: 999px;
        padding: 8px 14px;
        cursor: pointer;
      }

      button:disabled {
        opacity: 0.65;
        cursor: not-allowed;
      }

      .status {
        font-size: 0.84rem;
        color: #6d5f4d;
      }

      .preview {
        margin-top: 6px;
        border: 1px dashed #d9c5a7;
        border-radius: 12px;
        padding: 8px;
      }

      .preview img {
        width: min(240px, 100%);
        display: block;
        border-radius: 8px;
      }

      .manage-panel {
        margin-top: 18px;
        border-top: 1px solid #e6d7c2;
        padding-top: 14px;
      }

      .manage-title {
        margin: 0 0 8px;
        font-size: 0.98rem;
        color: #4a3e31;
      }

      .manage-search {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .manage-search input {
        flex: 1;
      }

      .manage-results {
        margin-top: 10px;
        display: grid;
        gap: 8px;
      }

      .manage-item {
        border: 1px solid #e6d7c2;
        border-radius: 10px;
        background: #fffdfa;
        padding: 9px 10px;
        display: flex;
        justify-content: space-between;
        gap: 10px;
        align-items: center;
      }

      .manage-item-main {
        min-width: 0;
      }

      .manage-item-title {
        font-size: 0.9rem;
        color: #30271e;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .manage-item-sub {
        margin-top: 2px;
        font-size: 0.78rem;
        color: #7a6d5c;
      }

      .status-pill {
        border-radius: 999px;
        padding: 3px 8px;
        font-size: 0.72rem;
        border: 1px solid #d4c2a8;
      }

      .status-pill.active {
        background: #e9f5e8;
        color: #2f6030;
        border-color: #bad9b8;
      }

      .status-pill.inactive {
        background: #f3ece4;
        color: #6e6356;
      }

      @media (max-width: 760px) {
        .row {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <main class="wrap">
      <section class="panel">
        <h1>Private Listing Admin</h1>
        <p>Accountless public site. Use this private page + admin key to add listings on the live website.</p>

        <form id="listingForm">
          <div class="row">
            <label>
              API Base URL
              <input id="apiBase" type="text" value="https://apartment-api-ptpn.onrender.com" />
            </label>
            <label>
              Admin Key
              <input id="adminKey" type="password" autocomplete="off" required />
            </label>
          </div>

          <div class="row">
            <label>
              Address
              <input id="address" type="text" required />
            </label>
            <label>
              Title
              <input id="title" type="text" required />
            </label>
          </div>

          <div class="row">
            <label>
              Price
              <input id="price" type="number" min="0" required />
            </label>
            <label>
              Borough
              <input id="borough" type="text" required />
            </label>
          </div>

          <div class="row">
            <label>
              Neighborhood
              <input id="neighborhood" type="text" required />
            </label>
            <label>
              Pets Policy
              <select id="petsPolicy">
                <option>CASE_BY_CASE</option>
                <option>ALLOWED</option>
                <option>NOT_ALLOWED</option>
                <option>CATS_ONLY</option>
                <option>DOGS_ONLY</option>
              </select>
            </label>
          </div>

          <div class="row">
            <label>
              Beds
              <input id="beds" type="number" min="0" step="0.5" />
            </label>
            <label>
              Baths
              <input id="baths" type="number" min="0" step="0.5" />
            </label>
          </div>

          <div class="row">
            <div class="picker-group">
              <label>Unit Features</label>
              <div class="picker-grid" id="unitFeaturePicker"></div>
              <input id="unitFeaturesCustom" type="text" placeholder="Other unit features (comma separated)" />
            </div>
            <div class="picker-group">
              <label>Building Amenities</label>
              <div class="picker-grid" id="buildingFeaturePicker"></div>
              <input
                id="buildingFeaturesCustom"
                type="text"
                placeholder="Other building amenities (comma separated)"
              />
            </div>
          </div>

          <div class="row">
            <label>
              Subway Lines (comma separated)
              <input id="subwayLines" type="text" placeholder="L, M" />
            </label>
            <label>
              Main Image
              <input id="imageFile" type="file" accept="image/*" />
            </label>
          </div>

          <div class="preview" id="imagePreviewWrap" hidden>
            <img id="imagePreview" alt="Selected image preview" />
          </div>

          <div class="row">
            <label>
              Floor Plan Image
              <input id="floorplanImageFile" type="file" accept="image/*" />
            </label>
            <div></div>
          </div>

          <div class="preview" id="floorplanImagePreviewWrap" hidden>
            <img id="floorplanImagePreview" alt="Selected floor plan image preview" />
          </div>

          <div class="row">
            <label>
              Map Image
              <input id="mapImageFile" type="file" accept="image/*" />
            </label>
            <div></div>
          </div>

          <div class="preview" id="mapImagePreviewWrap" hidden>
            <img id="mapImagePreview" alt="Selected map image preview" />
          </div>

          <div class="actions">
            <button id="submitBtn" type="submit">Create Listing</button>
            <span class="status" id="status">Ready.</span>
          </div>
        </form>

        <div class="actions" style="margin-top: 14px">
          <label style="display: inline-grid; gap: 4px; min-width: 220px">
            Delete Listing ID
            <input id="deleteListingId" type="number" min="1" placeholder="e.g. 42" />
          </label>
          <button id="deleteListingBtn" type="button">Delete Listing</button>
        </div>

        <section class="manage-panel">
          <h2 class="manage-title">Manage Existing Listings</h2>
          <div class="manage-search">
            <input id="manageSearchInput" type="text" placeholder="Search by address, title, neighborhood..." />
            <button id="manageSearchBtn" type="button">Search</button>
          </div>
          <div class="manage-results" id="manageResults"></div>
        </section>
      </section>
    </main>

    <script src="app-config.js"></script>
    <script>
      const apiBaseInput = document.getElementById("apiBase");
      const adminKeyInput = document.getElementById("adminKey");
      const form = document.getElementById("listingForm");
      const submitBtn = document.getElementById("submitBtn");
      const deleteListingIdInput = document.getElementById("deleteListingId");
      const deleteListingBtn = document.getElementById("deleteListingBtn");
      const manageSearchInput = document.getElementById("manageSearchInput");
      const manageSearchBtn = document.getElementById("manageSearchBtn");
      const manageResults = document.getElementById("manageResults");
      const statusEl = document.getElementById("status");
      const imageFileInput = document.getElementById("imageFile");
      const imagePreview = document.getElementById("imagePreview");
      const imagePreviewWrap = document.getElementById("imagePreviewWrap");
      const floorplanImageFileInput = document.getElementById("floorplanImageFile");
      const floorplanImagePreview = document.getElementById("floorplanImagePreview");
      const floorplanImagePreviewWrap = document.getElementById("floorplanImagePreviewWrap");
      const mapImageFileInput = document.getElementById("mapImageFile");
      const mapImagePreview = document.getElementById("mapImagePreview");
      const mapImagePreviewWrap = document.getElementById("mapImagePreviewWrap");
      const unitFeaturePicker = document.getElementById("unitFeaturePicker");
      const buildingFeaturePicker = document.getElementById("buildingFeaturePicker");
      const unitFeaturesCustomInput = document.getElementById("unitFeaturesCustom");
      const buildingFeaturesCustomInput = document.getElementById("buildingFeaturesCustom");

      const unitFeatureSelection = new Set();
      const buildingFeatureSelection = new Set();
      const UNIT_FEATURE_OPTIONS = [
        "Hardwood Floors",
        "Dishwasher",
        "Washer/Dryer",
        "Balcony",
        "Central AC",
        "Walk-in Closet",
        "High Ceilings",
      ];
      const BUILDING_FEATURE_OPTIONS = [
        "Elevator",
        "Doorman",
        "Roof Deck",
        "Gym",
        "Working Space",
        "Laundry",
        "Package Room",
        "Bike Room",
        "Kids Room",
        "Pickleball Court",
        "Podcast Room",
        "Pet Wash",
        "Party Room",
        "Theater Room",
      ];

      if (window.APP_CONFIG && window.APP_CONFIG.API_BASE_URL) {
        apiBaseInput.value = window.APP_CONFIG.API_BASE_URL;
      }

      let imageDataUrl = "";
      let floorplanImageDataUrl = "";
      let mapImageDataUrl = "";
      let isManageLoading = false;

      function setStatus(text) {
        statusEl.textContent = text;
      }

      function escapeHtml(value) {
        return String(value)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#39;");
      }

      function splitCsv(value) {
        if (!value) return [];
        return value
          .split(",")
          .map((part) => part.trim())
          .filter(Boolean);
      }

      function uniqCaseInsensitive(values) {
        const seen = new Set();
        const out = [];
        for (const raw of values) {
          const value = String(raw || "").trim();
          if (!value) continue;
          const key = value.toLowerCase();
          if (seen.has(key)) continue;
          seen.add(key);
          out.push(value);
        }
        return out;
      }

      function renderPicker(container, options, selectedSet) {
        container.innerHTML = options
          .map((name) => {
            const selected = selectedSet.has(name) ? " is-selected" : "";
            return `<button type="button" class="picker-chip${selected}" data-feature="${name}">${name}</button>`;
          })
          .join("");
      }

      function getCombinedFeatures(selectedSet, customInputEl) {
        const selected = Array.from(selectedSet);
        const custom = splitCsv(customInputEl.value);
        return uniqCaseInsensitive([...selected, ...custom]);
      }

      function renderManageResults(items) {
        if (!Array.isArray(items) || !items.length) {
          manageResults.innerHTML = `<div class="manage-item"><div class="manage-item-sub">No listings found.</div></div>`;
          return;
        }

        manageResults.innerHTML = items
          .map((listing) => {
            const address = listing.address || listing.title || `Listing #${listing.id}`;
            const statusClass = listing.isActive ? "active" : "inactive";
            const statusText = listing.isActive ? "Active" : "Inactive";
            const toggleText = listing.isActive ? "Set Inactive" : "Set Active";
            return `
              <div class="manage-item" data-id="${listing.id}">
                <div class="manage-item-main">
                  <div class="manage-item-title">${escapeHtml(address)} (#${listing.id})</div>
                  <div class="manage-item-sub">${escapeHtml(
                    `${listing.neighborhood || "N/A"}, ${listing.borough || "N/A"}`
                  )} â€¢ $${Number(listing.price || 0).toLocaleString()}/mo</div>
                </div>
                <div style="display:grid;gap:6px;justify-items:end;">
                  <span class="status-pill ${statusClass}">${statusText}</span>
                  <button type="button" class="manage-toggle-btn" data-id="${listing.id}" data-next="${listing.isActive ? "false" : "true"}">${toggleText}</button>
                </div>
              </div>
            `;
          })
          .join("");
      }

      async function fetchManageListings() {
        if (!adminKeyInput.value.trim()) {
          setStatus("Enter Admin Key first.");
          return;
        }
        if (isManageLoading) return;

        isManageLoading = true;
        manageSearchBtn.disabled = true;
        manageResults.innerHTML = `<div class="manage-item"><div class="manage-item-sub">Loading...</div></div>`;
        setStatus("Loading listings...");

        try {
          const url = new URL(`${apiBaseInput.value.replace(/\/$/, "")}/api/admin/listings`);
          const q = manageSearchInput.value.trim();
          if (q) url.searchParams.set("q", q);
          url.searchParams.set("limit", "40");

          const response = await fetch(url.toString(), {
            headers: { "x-admin-key": adminKeyInput.value },
          });
          const body = await response.json().catch(() => ({}));
          if (!response.ok) {
            throw new Error(body.error || `Request failed (${response.status})`);
          }

          renderManageResults(body.data || []);
          setStatus(`Loaded ${(body.data || []).length} listing(s).`);
        } catch (error) {
          const message =
            error && error.message === "Failed to fetch"
              ? "Network error. Confirm API Base URL is https://apartment-api-ptpn.onrender.com"
              : error.message;
          setStatus(`Error: ${message}`);
          manageResults.innerHTML = `<div class="manage-item"><div class="manage-item-sub">Failed to load listings.</div></div>`;
        } finally {
          isManageLoading = false;
          manageSearchBtn.disabled = false;
        }
      }

      async function updateListingStatus(id, isActive) {
        if (!adminKeyInput.value.trim()) {
          setStatus("Enter Admin Key first.");
          return;
        }

        setStatus(`Updating listing #${id}...`);
        try {
          const response = await fetch(
            `${apiBaseInput.value.replace(/\/$/, "")}/api/admin/listings/${id}/status`,
            {
              method: "PATCH",
              headers: {
                "content-type": "application/json",
                "x-admin-key": adminKeyInput.value,
              },
              body: JSON.stringify({ isActive }),
            }
          );
          const body = await response.json().catch(() => ({}));
          if (!response.ok) {
            throw new Error(body.error || `Request failed (${response.status})`);
          }

          setStatus(`Listing #${id} set to ${isActive ? "Active" : "Inactive"}.`);
          await fetchManageListings();
        } catch (error) {
          const message =
            error && error.message === "Failed to fetch"
              ? "Network error. Confirm API Base URL is https://apartment-api-ptpn.onrender.com"
              : error.message;
          setStatus(`Error: ${message}`);
        }
      }

      function optionalNumber(value) {
        if (!value) return null;
        const parsed = Number(value);
        return Number.isFinite(parsed) ? parsed : null;
      }

      function loadImageFromDataUrl(dataUrl) {
        return new Promise((resolve, reject) => {
          const img = new Image();
          img.onload = () => resolve(img);
          img.onerror = () => reject(new Error("Failed to decode image."));
          img.src = dataUrl;
        });
      }

      async function compressImageFile(file) {
        const sourceDataUrl = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(String(reader.result || ""));
          reader.onerror = () => reject(new Error("Failed to read image file."));
          reader.readAsDataURL(file);
        });

        const img = await loadImageFromDataUrl(sourceDataUrl);
        const maxSide = 1600;
        const longestSide = Math.max(img.naturalWidth, img.naturalHeight);
        const scale = longestSide > maxSide ? maxSide / longestSide : 1;
        const width = Math.max(1, Math.round(img.naturalWidth * scale));
        const height = Math.max(1, Math.round(img.naturalHeight * scale));

        const canvas = document.createElement("canvas");
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, width, height);

        // JPEG at moderate quality keeps payload under request limits for admin JSON.
        return canvas.toDataURL("image/jpeg", 0.82);
      }

      async function handleImageSelection(file, onDataUrlReady, previewImg, previewWrap, label) {
        if (!file) {
          onDataUrlReady("");
          previewWrap.hidden = true;
          previewImg.src = "";
          return;
        }

        try {
          setStatus(`Optimizing ${label}...`);
          const dataUrl = await compressImageFile(file);
          onDataUrlReady(dataUrl);
          previewImg.src = dataUrl;
          previewWrap.hidden = !dataUrl;
          const approxKb = Math.round((dataUrl.length * 0.75) / 1024);
          setStatus(`${label} ready (~${approxKb} KB).`);
        } catch (_error) {
          onDataUrlReady("");
          previewWrap.hidden = true;
          previewImg.src = "";
          setStatus(`Failed to process ${label}.`);
        }
      }

      imageFileInput.addEventListener("change", async (event) => {
        const file = event.target.files && event.target.files[0];
        await handleImageSelection(
          file,
          (value) => {
            imageDataUrl = value;
          },
          imagePreview,
          imagePreviewWrap,
          "main image"
        );
      });

      mapImageFileInput.addEventListener("change", async (event) => {
        const file = event.target.files && event.target.files[0];
        await handleImageSelection(
          file,
          (value) => {
            mapImageDataUrl = value;
          },
          mapImagePreview,
          mapImagePreviewWrap,
          "map image"
        );
      });

      floorplanImageFileInput.addEventListener("change", async (event) => {
        const file = event.target.files && event.target.files[0];
        await handleImageSelection(
          file,
          (value) => {
            floorplanImageDataUrl = value;
          },
          floorplanImagePreview,
          floorplanImagePreviewWrap,
          "floor plan image"
        );
      });

      unitFeaturePicker.addEventListener("click", (event) => {
        const chip = event.target.closest(".picker-chip");
        if (!chip) return;
        const name = chip.dataset.feature;
        if (!name) return;
        if (unitFeatureSelection.has(name)) {
          unitFeatureSelection.delete(name);
        } else {
          unitFeatureSelection.add(name);
        }
        renderPicker(unitFeaturePicker, UNIT_FEATURE_OPTIONS, unitFeatureSelection);
      });

      buildingFeaturePicker.addEventListener("click", (event) => {
        const chip = event.target.closest(".picker-chip");
        if (!chip) return;
        const name = chip.dataset.feature;
        if (!name) return;
        if (buildingFeatureSelection.has(name)) {
          buildingFeatureSelection.delete(name);
        } else {
          buildingFeatureSelection.add(name);
        }
        renderPicker(buildingFeaturePicker, BUILDING_FEATURE_OPTIONS, buildingFeatureSelection);
      });

      renderPicker(unitFeaturePicker, UNIT_FEATURE_OPTIONS, unitFeatureSelection);
      renderPicker(buildingFeaturePicker, BUILDING_FEATURE_OPTIONS, buildingFeatureSelection);

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        setStatus("Creating listing...");
        submitBtn.disabled = true;

        const payload = {
          title: document.getElementById("title").value.trim(),
          address: document.getElementById("address").value.trim(),
          price: Number(document.getElementById("price").value),
          borough: document.getElementById("borough").value.trim(),
          neighborhood: document.getElementById("neighborhood").value.trim(),
          petsPolicy: document.getElementById("petsPolicy").value,
          beds: optionalNumber(document.getElementById("beds").value.trim()),
          baths: optionalNumber(document.getElementById("baths").value.trim()),
          unitFeatures: getCombinedFeatures(unitFeatureSelection, unitFeaturesCustomInput),
          buildingFeatures: getCombinedFeatures(buildingFeatureSelection, buildingFeaturesCustomInput),
          subwayLines: splitCsv(document.getElementById("subwayLines").value),
        };

        if (imageDataUrl) payload.imageUrl = imageDataUrl;
        if (floorplanImageDataUrl) payload.floorplanImageUrl = floorplanImageDataUrl;
        if (mapImageDataUrl) payload.mapImageUrl = mapImageDataUrl;

        try {
          const response = await fetch(`${apiBaseInput.value.replace(/\/$/, "")}/api/admin/listings`, {
            method: "POST",
            headers: {
              "content-type": "application/json",
              "x-admin-key": adminKeyInput.value,
            },
            body: JSON.stringify(payload),
          });

          const body = await response.json().catch(() => ({}));
          if (!response.ok) {
            throw new Error(body.error || `Request failed (${response.status})`);
          }

          setStatus(`Created listing #${body.data.id}`);
          form.reset();
          unitFeatureSelection.clear();
          buildingFeatureSelection.clear();
          renderPicker(unitFeaturePicker, UNIT_FEATURE_OPTIONS, unitFeatureSelection);
          renderPicker(buildingFeaturePicker, BUILDING_FEATURE_OPTIONS, buildingFeatureSelection);
          imageDataUrl = "";
          floorplanImageDataUrl = "";
          mapImageDataUrl = "";
          imagePreviewWrap.hidden = true;
          imagePreview.src = "";
          floorplanImagePreviewWrap.hidden = true;
          floorplanImagePreview.src = "";
          mapImagePreviewWrap.hidden = true;
          mapImagePreview.src = "";
        } catch (error) {
          const message =
            error && error.message === "Failed to fetch"
              ? "Network error. Confirm API Base URL is https://apartment-api-ptpn.onrender.com"
              : error.message;
          setStatus(`Error: ${message}`);
        } finally {
          submitBtn.disabled = false;
        }
      });

      deleteListingBtn.addEventListener("click", async () => {
        if (!adminKeyInput.value.trim()) {
          setStatus("Enter Admin Key first.");
          return;
        }
        const listingId = Number(deleteListingIdInput.value);
        if (!Number.isInteger(listingId) || listingId <= 0) {
          setStatus("Enter a valid Listing ID to delete.");
          return;
        }

        const confirmed = window.confirm(`Delete listing #${listingId}?`);
        if (!confirmed) return;

        setStatus(`Deleting listing #${listingId}...`);
        deleteListingBtn.disabled = true;

        try {
          const response = await fetch(
            `${apiBaseInput.value.replace(/\/$/, "")}/api/admin/listings/${listingId}`,
            {
              method: "DELETE",
              headers: {
                "x-admin-key": adminKeyInput.value,
              },
            }
          );
          const body = await response.json().catch(() => ({}));
          if (!response.ok) {
            throw new Error(body.error || `Request failed (${response.status})`);
          }
          setStatus(`Deleted listing #${listingId}.`);
          deleteListingIdInput.value = "";
        } catch (error) {
          const message =
            error && error.message === "Failed to fetch"
              ? "Network error. Confirm API Base URL is https://apartment-api-ptpn.onrender.com"
              : error.message;
          setStatus(`Error: ${message}`);
        } finally {
          deleteListingBtn.disabled = false;
        }
      });

      manageSearchBtn.addEventListener("click", fetchManageListings);
      manageSearchInput.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          event.preventDefault();
          fetchManageListings();
        }
      });

      manageResults.addEventListener("click", async (event) => {
        const btn = event.target.closest(".manage-toggle-btn");
        if (!btn) return;
        const id = Number(btn.dataset.id);
        const next = btn.dataset.next === "true";
        if (!Number.isInteger(id) || id <= 0) return;
        await updateListingStatus(id, next);
      });
    </script>
  </body>
</html>
